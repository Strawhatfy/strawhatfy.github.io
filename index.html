<!DOCTYPE html>





<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">
  <link rel="alternate" href="/atom.xml" title="书影" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
<meta property="og:type" content="website">
<meta property="og:title" content="书影">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="书影">
<meta property="og:description" content="疏影横斜水清浅，暗香浮动月黄昏。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="书影">
<meta name="twitter:description" content="疏影横斜水清浅，暗香浮动月黄昏。">
  <link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>书影</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">书影</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <div id="posts" class="posts-expand">
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/07/ssl.cert/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/07/07/ssl.cert/" class="post-title-link" itemprop="url">SSL 自签名证书</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-07-07 11:25:01" itemprop="dateCreated datePublished" datetime="2019-07-07T11:25:01+08:00">2019-07-07</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/服务端基础/" itemprop="url" rel="index"><span itemprop="name">服务端基础</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SSL-自签名证书"><a href="#SSL-自签名证书" class="headerlink" title="SSL 自签名证书"></a>SSL 自签名证书</h1><h2 id="X-509-格式标准"><a href="#X-509-格式标准" class="headerlink" title="X.509 格式标准"></a>X.509 格式标准</h2><p>X.509：这是一种公钥证书的格式格式标准（<br><a href="https://zh.wikipedia.org/wiki/X.509），详情参考" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/X.509），详情参考</a> <a href="https://tools.ietf.org/html/rfc5280" target="_blank" rel="noopener">RFC5280</a></p>
<h2 id="编码格式"><a href="#编码格式" class="headerlink" title="编码格式"></a>编码格式</h2><ul>
<li><p>PEM：Privacy Enhanced Mail<br>  文本格式，Apache 和 Unix-like 服务器偏向使用这种编码格式。查看 PEM 格式的证书（可以包含私钥）：<br>  <code>openssl x509 -in certificate.pem -text -noout</code></p>
<ul>
<li>DER： Distinguished Encoding Rules<br> 二进制格式， Java 和 Windows 服务器偏向使用这种编码格式。查看 DER 格式的证书（单纯的证书，不可包含私钥）:<br> <code>openssl x509 -in certificate.der -inform der -text -noout</code></li>
</ul>
</li>
</ul>
<p>PEM 转 DER：<br><code>openssl x509 -in cert.crt -outform der -out cert.der</code></p>
<p>DER 转 PEM:<br><code>openssl x509 -in cert.crt -inform der -outform pem -out cert.pem</code></p>
<p><strong>注：</strong> </p>
<ol>
<li>查看/转换密钥（公钥或者私钥）文件则使用 <code>openssl rsa</code>；</li>
<li>查看/转换的是 CSR 文件则使用 <code>openssl req</code>。</li>
</ol>
<h2 id="文件后缀名"><a href="#文件后缀名" class="headerlink" title="文件后缀名"></a>文件后缀名</h2><ul>
<li>crt，certificate 的缩写，Unix-like 证书文件的常见后缀名，通常是 PEM 编码。</li>
<li>cer，也是 certificate 的缩写，Windows 证书文件的常见后缀名，通常是 DER 编码。</li>
<li>key, 通常是公钥或者私钥文件的后缀名。</li>
<li>csr，Certificate Signing Request，证书签名申请文件后缀名。</li>
<li>pfx/p12，predecessor of PKCS#12，将证书和私钥存放在一个文件中，使用 DER 编码。 通常是 IIS 使用，Unix 系服务器通常证书和私钥是放在不同的文件中。</li>
<li>JKS，Java Key Storage，通常用在 tomcat 中，Java 提供 keytool 工具支持将 pfx/p12 转换成 JKS：<code>keytool -importkeystore -srckeystore test.pfx -srcstoretype PKCS12 -deststoretype JKS -destkeystore test.jks</code></li>
</ul>
<h3 id="PEM-pfx-p12"><a href="#PEM-pfx-p12" class="headerlink" title="PEM  pfx/p12"></a>PEM <--> pfx/p12</--></h3><p>Unix 系的 PEM 证书转 pfx/p12 格式证书：<br><code>openssl pkcs12 -export -in certificate.crt -inkey privateKey.key  [-certfile CACert.crt] -out certificate.pfx</code> </p>
<p> 反过来：<br> <code>openssl pkcs12 -in certificate.pfx -nodes -out certificate.pem</code></p>
<p>因为 <code>certificate.pem</code>  是一个同时包含证书和私钥的 PEM 证书，进一步可以通过下面命令分离成单独 PEM 证书和私钥 2 个文件：<br> <code>openssl rsa -in certificate.pem -out privateKey.key</code><br><code>openssl x509 -in server.pem -out certificate.crt</code></p>
<h2 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h2><h3 id="自签名证书（-x-509-v1）"><a href="#自签名证书（-x-509-v1）" class="headerlink" title="自签名证书（ x.509 v1）"></a>自签名证书（ x.509 v1）</h3><p>自己签署的证书，没有 CA 可以证明其有效性，无法被吊销。由于大多数移动平台不支持使用自签名证书，因此不推荐使用。用下面方法可以生成 x.509 v1 版本的自签名证书。</p>
<ol>
<li><p>生成 RSA 私钥（不加密的私钥）：</p>
<p> <code>openssl genrsa -out server.key 1024</code>  </p>
<p> 注：通过 <code>man genrsa</code>  查看使用手册。如果证书要使用在 Nginx 上，为避免每次 nginx reload ssl 都要手动输入口令，这里生成的私钥不加密。</p>
</li>
<li><p>创建证书签名申请（CSR， Certificate Signning Request）:</p>
<p> <code>openssl req -new -key server.key -out server.csr</code></p>
</li>
<li><p>使用前面生成的私钥对 CSR 进行签名生成自签名证书:</p>
<p> <code>openssl x509 -req -days 3650 -in server.csr -signkey server.key -out server.crt</code></p>
</li>
</ol>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2019/07/07/ssl.cert/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/22/kvm.disk.cache.modes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/05/22/kvm.disk.cache.modes/" class="post-title-link" itemprop="url">KVM 磁盘缓存模式</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-22 23:44:17" itemprop="dateCreated datePublished" datetime="2019-05-22T23:44:17+08:00">2019-05-22</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/virtualization/" itemprop="url" rel="index"><span itemprop="name">virtualization</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="KVM-磁盘缓存模式"><a href="#KVM-磁盘缓存模式" class="headerlink" title="KVM 磁盘缓存模式"></a>KVM 磁盘缓存模式</h1><p>本笔记内容无原创，整理自如下资料：</p>
<ul>
<li><a href="https://johng.cn/linux-io-sync/" target="_blank" rel="noopener">Linux中如何保证数据安全落盘</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_tuning_and_optimization_guide/sect-virtualization_tuning_optimization_guide-blockio-caching" target="_blank" rel="noopener">RHEL sect-virtualization_tuning_optimization_guide-blockio-caching</a></li>
<li><a href="https://turlucode.com/qemu-disk-io-performance-comparison-native-or-threads-windows-10-version/#1528572626148-2b30f3e4-f00f" target="_blank" rel="noopener">GUIDES  5.3K<br>QEMU Disk IO performance comparison: Native or threads?</a></li>
<li><a href="https://www.cnblogs.com/tcicy/p/10193613.html" target="_blank" rel="noopener">KVM总结-KVM性能优化之磁盘IO优化</a></li>
</ul>
<h2 id="Cache-modes"><a href="#Cache-modes" class="headerlink" title="Cache modes"></a>Cache modes</h2><p>KVM 目前支持的磁盘缓存模式主要有 none，writethrough，writeback，directsync，unsafe 这 5 种。后面 2 种通常很少使用到。</p>
<h3 id="none"><a href="#none" class="headerlink" title="none"></a>none</h3><ul>
<li>I/O from the guest is not cached on the host, but may be kept in a writeback disk cache. Use this option for guests with large I/O requirements.（guest 使用 writeback， host 不使用 page cache，相当于 guest 直接访问主机磁盘。）</li>
</ul>
<p>这种模式下虚拟机磁盘镜像文件或者块设备会使用 O_DIRECT 语义， 则 host 的 page cache 被绕过， I/O 直接在 qemu-kvm 的用户空间 buffers 和 host 的存储设备间发生。因为实际存储设备可能在写数据放到写队列后就上报写完成，虚拟机上的存储控制器被告知有回写缓存（writeback cache）， 所以 guest 需要下发刷盘（flush）命令来保证数据一致（落盘）。相当于直接访问 host 磁盘，性能不错。</p>
<blockquote>
<blockquote>
<p>This mode causes qemu-kvm to interact with the disk image file or block device with O_DIRECT semantics, so the host page cache is bypassed and I/O happens directly between the qemu-kvm userspace buffers and the storage device. Because the actual storage device may report a write as completed when placed in its write queue only, the guest’s virtual storage adapter is informed that there is a writeback cache, so the guest would be expected to send down flush commands as needed to manage data integrity. Equivalent to direct access to your hosts’ disk,performance wise.</p>
</blockquote>
</blockquote>
<h3 id="writethrough"><a href="#writethrough" class="headerlink" title="writethrough"></a>writethrough</h3><ul>
<li>I/O from the guest is cached on the host but written through to the physical medium. （guest 使用 wirtethrough， host 使用 page cache。）</li>
</ul>
<p>这种模式下会为每次写操作执行 fdatasync（原文是 fsync 与后面 O_DSYNC 不太一致）， 是一种安全的缓存模式，不用担心丢失数据，但同时也比较慢。这种模式下虚拟机磁盘镜像文件或者块设备被设置成 O_DSYNC 语义， 必须等待所有写数据落盘以后才上报写完成。 host 的 page cache 工作在所谓的 writethrough 模式。guest 的存储控制器会被告知没有 writecache， 所以 guest 不必下发 flush 命令来保证数据一致。存储设备的行为好像是透过缓存（writethrough cache）。</p>
<blockquote>
<blockquote>
<p>Writethrough make a fsync for each write. So it’s the more secure cache mode, you can’t loose data. It’s also the slower. This mode causes qemu-kvm to interact with the disk image file or block device with O_DSYNC semantics, where writes are reported as completed only when the data has been committed to the storage device. The host page cache is used in what can be termed a writethrough caching mode. The guest’s virtual storage adapter is informed that there is no writeback cache, so the guest would not need to send down flush commands to manage data integrity. The storage behaves as if there is a writethrough cache.<br>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2019/05/22/kvm.disk.cache.modes/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/20/v2ray.tls.nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/05/20/v2ray.tls.nginx/" class="post-title-link" itemprop="url">v2ray + Nginx + TLS(CentOS 7)</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-05-20 23:11:01" itemprop="dateCreated datePublished" datetime="2019-05-20T23:11:01+08:00">2019-05-20</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/misc/" itemprop="url" rel="index"><span itemprop="name">misc</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="v2ray-Nginx-TLS"><a href="#v2ray-Nginx-TLS" class="headerlink" title="v2ray + Nginx + TLS"></a>v2ray + Nginx + TLS</h1><h2 id="安装-v2ray"><a href="#安装-v2ray" class="headerlink" title="安装 v2ray"></a>安装 v2ray</h2><ol>
<li>安装 v2ray 最新版本：</li>
</ol>
<p><code>bash &lt;(curl -L -s https://install.direct/go.sh)</code></p>
<ol start="2">
<li>编辑 v2ray 配置文件 <code>/etc/v2ray/config.json</code>，这个配置文件简单启用 2 个传输通道，分别是 port 8081 上的 websocket 和 port 8082 上的 mkcp，其他更多配置请参考官方文档：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"log"</span>: &#123;</span><br><span class="line">        <span class="attr">"access"</span>: <span class="string">"/var/log/v2ray/access.log"</span>,</span><br><span class="line">        <span class="attr">"error"</span>: <span class="string">"/var/log/v2ray/error.log"</span>,</span><br><span class="line">        <span class="attr">"loglevel"</span>: <span class="string">"warning"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"dns"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"stats"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"inbounds"</span>: [&#123;</span><br><span class="line">            <span class="attr">"tag"</span>: <span class="string">"in-0"</span>,</span><br><span class="line">            <span class="attr">"settings"</span>: &#123;</span><br><span class="line">                <span class="attr">"clients"</span>: [&#123;</span><br><span class="line">                        <span class="attr">"id"</span>: <span class="string">"xxx"</span>,</span><br><span class="line">                        <span class="attr">"alterId"</span>: <span class="number">64</span>,</span><br><span class="line">                        <span class="attr">"level"</span>: <span class="number">1</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"streamSettings"</span>: &#123;</span><br><span class="line">                <span class="attr">"network"</span>: <span class="string">"ws"</span>,</span><br><span class="line">                <span class="attr">"wsSettings"</span>: &#123;</span><br><span class="line">                    <span class="attr">"path"</span>: <span class="string">"/ray"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"security"</span>: <span class="string">"none"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"listen"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">            <span class="attr">"port"</span>: <span class="number">8081</span>,</span><br><span class="line">            <span class="attr">"protocol"</span>: <span class="string">"vmess"</span></span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            <span class="attr">"tag"</span>: <span class="string">"in-1"</span>,</span><br><span class="line">            <span class="attr">"settings"</span>: &#123;</span><br><span class="line">                <span class="attr">"clients"</span>: [&#123;</span><br><span class="line">                        <span class="attr">"id"</span>: <span class="string">"xxx"</span>,</span><br><span class="line">                        <span class="attr">"alterId"</span>: <span class="number">64</span>,</span><br><span class="line">                        <span class="attr">"level"</span>: <span class="number">1</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"streamSettings"</span>: &#123;</span><br><span class="line">                <span class="attr">"network"</span>: <span class="string">"kcp"</span>,</span><br><span class="line">                <span class="attr">"kcpSettings"</span>: &#123;</span><br><span class="line">                    <span class="attr">"header"</span>: &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"dtls"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"security"</span>: <span class="string">"none"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"port"</span>: <span class="number">8082</span>,</span><br><span class="line">            <span class="attr">"protocol"</span>: <span class="string">"vmess"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"outbounds"</span>: [&#123;</span><br><span class="line">            <span class="attr">"tag"</span>: <span class="string">"direct"</span>,</span><br><span class="line">            <span class="attr">"settings"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"protocol"</span>: <span class="string">"freedom"</span></span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            <span class="attr">"tag"</span>: <span class="string">"blocked"</span>,</span><br><span class="line">            <span class="attr">"settings"</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">"protocol"</span>: <span class="string">"blackhole"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"routing"</span>: &#123;</span><br><span class="line">        <span class="attr">"rules"</span>: [&#123;</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"field"</span>,</span><br><span class="line">                <span class="attr">"ip"</span>: [</span><br><span class="line">                    <span class="string">"geoip:private"</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">"outboundTag"</span>: <span class="string">"blocked"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"domainStrategy"</span>: <span class="string">"AsIs"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"policy"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"reverse"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"transport"</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2019/05/20/v2ray.tls.nginx/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/10/MongoDB-datatypes-storage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2017/12/10/MongoDB-datatypes-storage/" class="post-title-link" itemprop="url">MongoDB 数据类型及存储</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2017-12-10 11:25:01" itemprop="dateCreated datePublished" datetime="2017-12-10T11:25:01+08:00">2017-12-10</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="What-is-MongoDB"><a href="#What-is-MongoDB" class="headerlink" title="What is MongoDB?"></a>What is MongoDB?</h1><p>MongoDB is a document database with the scalability and flexibility that you want with the querying and indexing that you need.</p>
<p><strong>Stores data in flexible, JSON-like documents.</strong></p>
<p>Document =&gt; Collection =&gt; Database</p>
<p>ref: <a href="[https://www.mongodb.com/what-is-mongodb](https://www.mongodb.com/what-is-mongodb">what-is-mongodb</a>).</p>
<h1 id="Data-Type"><a href="#Data-Type" class="headerlink" title="Data Type"></a>Data Type</h1><h2 id="BSON-vs-JSON"><a href="#BSON-vs-JSON" class="headerlink" title="BSON vs JSON"></a>BSON vs JSON</h2><p><a href="[http://bsonspec.org](http://bsonspec.org">BSON [bee · sahn]</a>), short for Binary JSON, is a binary-encoded serialization of JSON-like documents.</p>
<ol>
<li><p>继承自 JSON，具备 JSON 的通用性与 schema-less（例如与 Protocol Buffers 比较）；</p>
</li>
<li><p>扩展了 JSON 的数据类型，提供了 JSON 没有的一些数据类型，例如： Date 和 BinData（byte array，有了这种类型以后就不需要像 JSON 一样需要先 base64 编码再存储，减少了计算和存储的开销）；</p>
</li>
<li><p>BSON 的存储结构相比较 JSON 有更快的遍历速度；</p>
</li>
<li><p>BSON 的存储有数据类型的支持，字段更新的时候更快更方便。JSON 的存储由于没有数据类型的支持，字段的更新需要移动文档的内容，操作代价大。</p>
</li>
</ol>
<p>BSON Spec ref：<a href="[http://bsonspec.org/spec.html](http://bsonspec.org/spec.html">bsonspec</a>)</p>
<p>头部存有数据结构的长度，有数据类型的支持，遍历起来快，不用像 JSON 一样进行各种复杂的数据结构匹配。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"hello"</span>: <span class="string">"world"</span>&#125;</span><br><span class="line"></span><br><span class="line">\x16\x00\x00\x00                   // total document size</span><br><span class="line">\x02                               // 0x02 = type String</span><br><span class="line">hello\x00                          // field name</span><br><span class="line">\x06\x00\x00\x00world\x00          // field value</span><br><span class="line">\x00                               // 0x00 = type EOO ('end of object')</span><br><span class="line"></span><br><span class="line">&#123;<span class="attr">"BSON"</span>: [<span class="string">"awesome"</span>, <span class="number">5.05</span>, <span class="number">1986</span>]&#125;</span><br><span class="line"></span><br><span class="line">\x31\x00\x00\x00</span><br><span class="line">\x04BSON\x00</span><br><span class="line">\x26\x00\x00\x00</span><br><span class="line">\x02\x30\x00\x08\x00\x00\x00awesome\x00</span><br><span class="line">\x01\x31\x00\x33\x33\x33\x33\x33\x33\x14\x40</span><br><span class="line">\x10\x32\x00\xc2\x07\x00\x00</span><br><span class="line">\x00</span><br><span class="line">\x00</span><br></pre></td></tr></table></figure>
<h2 id="BSON-Types"><a href="#BSON-Types" class="headerlink" title="BSON Types"></a>BSON Types</h2><p>BSON is a binary serialization format used to store documents and make remote procedure calls in MongoDB.</p>
<p>ref：<a href="https://docs.mongodb.com/v2.6/reference/bson-types/" target="_blank" rel="noopener">https://docs.mongodb.com/v2.6/reference/bson-types/</a></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Number</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Double</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>String</td>
<td>2</td>
<td></td>
</tr>
<tr>
<td>Object</td>
<td>3</td>
<td></td>
</tr>
<tr>
<td>Array</td>
<td>4</td>
<td></td>
</tr>
<tr>
<td>Binary Data</td>
<td>5</td>
<td></td>
</tr>
<tr>
<td>Undefined</td>
<td>6</td>
<td>deprecated</td>
</tr>
<tr>
<td>Object id</td>
<td>7</td>
<td></td>
</tr>
<tr>
<td>Boolean</td>
<td>8</td>
<td></td>
</tr>
<tr>
<td>Date</td>
<td>9</td>
<td></td>
</tr>
<tr>
<td>Null</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>Regular Expression</td>
<td>12</td>
<td></td>
</tr>
<tr>
<td>JavaScript</td>
<td>13</td>
<td></td>
</tr>
<tr>
<td>Symbol</td>
<td>14</td>
<td>deprecated</td>
</tr>
<tr>
<td>JavaScript (with scope)</td>
<td>15</td>
<td></td>
</tr>
<tr>
<td>32-bit integer</td>
<td>16</td>
<td></td>
</tr>
<tr>
<td>Timestamp</td>
<td>17</td>
<td></td>
</tr>
<tr>
<td>64-bit integer</td>
<td>18</td>
<td></td>
</tr>
<tr>
<td>Min key</td>
<td>255</td>
<td>Query with -1.</td>
</tr>
<tr>
<td>Max key</td>
<td>127</td>
</tr>
</tbody>
</table>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2017/12/10/MongoDB-datatypes-storage/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/15/tornado.web_secure_cookies_xsrf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2016/02/15/tornado.web_secure_cookies_xsrf/" class="post-title-link" itemprop="url">tornado.web.RequestHandler 安全 Cookie 与 XSRF 防护</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2016-02-15 22:00:01" itemprop="dateCreated datePublished" datetime="2016-02-15T22:00:01+08:00">2016-02-15</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tornado/" itemprop="url" rel="index"><span itemprop="name">tornado</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>网站安全不外乎就是信息安全的三个基本要点，简单来说就是：</p>
<ol>
<li>机密性，网站要保护用户的隐私数据不被窃取，账号不被盗用，面对的主要的攻击方式是植入木马；</li>
<li>可用性，网站要保证其服务是可用的，面对的主要的攻击方式是DOS和DDOS；</li>
<li>完整性，网站要确保用户请求信息或数据不被未授权的篡改或在篡改后能够被迅速发现，面对主要的攻击方式是XSS和CSRF；</li>
</ol>
<p>这篇笔记主要分析 Tornado 对 CSRF 的防范。众所周知 HTTP 协议是一个无状态协议，这便意味着每次请求都是独立的，要在两次请求之间共享数据（或者称为保持会话状态）便必须在请求时重传数据。 Cookie 和 Session 分别是客户端和服务端保持会话状态的机制。 Tornado Web 框架中已经默认对 Cookie 提供了支持，而对 Session 却没有提供内置的 Session 实现。我猜测这是因为考虑到现在的 Web 应用往往比较复杂并需要分布式存储 Session 数据，若要实现一个大而全 Session 来满足复杂的应能用场景基本上不可能，干脆就不内置而交由应用去自行根据需求来实现。</p>
<p>通常 Cookie 的使用不当往往导致安全问题， Tornado 在设计时便考虑到这个问题，为此内置 secure cookies 来阻止客户端非法修改 cookie 数据，以此来防范常见的 cookie 安全漏洞。Tornado 官方文档中专门用了一节 <a href="http://www.tornadoweb.org/en/stable/guide/security.html" target="_blank" rel="noopener">《认证和安全》</a> 来介绍相关内容（中文翻译：<a href="https://tornado-zh.readthedocs.org/zh/latest/guide/security.html" target="_blank" rel="noopener">https://tornado-zh.readthedocs.org/zh/latest/guide/security.html</a> ），在网上也有很多介绍这方面的资料，比如：<a href="http://demo.pythoner.com/itt2zh/ch6.html#ch6-2-1" target="_blank" rel="noopener">http://demo.pythoner.com/itt2zh/ch6.html#ch6-2-1</a> 就写的很好，所以这篇笔记不再从 “如何使用 secure cookies 来编写安全应用” 的角度来讨论，而是结合代码分析实现原理。</p>
<h3 id="Secure-Cookies"><a href="#Secure-Cookies" class="headerlink" title="Secure Cookies"></a>Secure Cookies</h3><p>Cookies 是不安全的，可以被客户端轻易修改和伪造，Tornado 的 Secure Cookies 使用加密签名来验证 Cookie 数据是否被非法修改过，签名后的 Cookie 数据包括时间戳、 HMAC 签名和编码后的 cookie 值等信。<code>tornado.web.RequestHandler</code> 通过 <code>set_secure_cookie()</code> 和 <code>get_secure_cookie()</code> 方法来设置和获取 Secure Cookies，因为 HMAC 签名密钥是由 <code>tornado.web.Application</code> 实例来提供的，所以在实例化  <code>tornado.web.Application</code> 时必须在 <code>settings</code> 中提供 <code>cookie_secret</code> 参数才能使用安全 Cookies。否则，<code>self.require_setting(&quot;cookie_secret&quot;, &quot;secure cookies&quot;)</code> 会抛出未设置 <code>cookie_secret</code>  异常。</p>
<p><code>cookie_secret</code> 参数是一个随机字节序列，用来制作 HMAC 签名，可以使用下面的代码来生成：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64, uuid</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(uuid.uuid4().bytes + uuid.uuid4().bytes)</span><br></pre></td></tr></table></figure></p>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2016/02/15/tornado.web_secure_cookies_xsrf/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/30/tornado.web_handle_exception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2016/01/30/tornado.web_handle_exception/" class="post-title-link" itemprop="url">tornado.web.RequestHandler 异常处理</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2016-01-30 14:00:01" itemprop="dateCreated datePublished" datetime="2016-01-30T14:00:01+08:00">2016-01-30</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tornado/" itemprop="url" rel="index"><span itemprop="name">tornado</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="RequestHandler-异常处理"><a href="#RequestHandler-异常处理" class="headerlink" title="RequestHandler 异常处理"></a>RequestHandler 异常处理</h3><p>之前的笔记中已经提到过 <code>RequestHandler</code> 的 <code>_execute</code> 方法完全处于一个异常处理块中，所以异常处理入口 <code>_handle_request_exception</code> 便在这里开始处理流程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_handle_request_exception</span><span class="params">(self, e)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(e, Finish):</span><br><span class="line">        <span class="comment"># Not an error; just finish the request without logging.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._finished:</span><br><span class="line">            self.finish()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    self.log_exception(*sys.exc_info())</span><br><span class="line">    <span class="keyword">if</span> self._finished:</span><br><span class="line">        <span class="comment"># Extra errors after the request has been finished should</span></span><br><span class="line">        <span class="comment"># be logged, but there is no reason to continue to try and</span></span><br><span class="line">        <span class="comment"># send a response.</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(e, HTTPError):</span><br><span class="line">        <span class="keyword">if</span> e.status_code <span class="keyword">not</span> <span class="keyword">in</span> httputil.responses <span class="keyword">and</span> <span class="keyword">not</span> e.reason:</span><br><span class="line">            gen_log.error(<span class="string">"Bad HTTP status code: %d"</span>, e.status_code)</span><br><span class="line">            self.send_error(<span class="number">500</span>, exc_info=sys.exc_info())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.send_error(e.status_code, exc_info=sys.exc_info())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.send_error(<span class="number">500</span>, exc_info=sys.exc_info())</span><br></pre></td></tr></table></figure>
<p>由前面的代码可以看到，与请求异常处理相关的自定义异常类型是 <code>Finish</code>、<code>HTTPError</code>，方法有 <code>log_exception</code> 和 <code>send_error</code>。</p>
<p>在 <code>_handle_request_exception</code> 的处理流程中，除去 <code>Finish</code> 类型外的所有异常都需要调用 <code>log_exception</code> 方法来记录异常信息。如果响应没有结束，还需要尝试向客户端响应异常信息（只所以说是 “尝试”，是因为我们无法修改已经 <code>flush</code> 到客户端的数据，只能在尚未 <code>flush</code> 过数据时响应异常信息）。</p>
<h4 id="Finish"><a href="#Finish" class="headerlink" title="Finish"></a>Finish</h4><p><code>Finish</code> 是一个特别的自定义异常类型，为应用程序提供一种提前结束请求的方式。因抛出 <code>Finish</code> 而结束的请求不会输出一个异常响应（即不被视为请求处理异常）。如代码中所示，在 <code>RequestHandler</code> 请求处理过程中抛出 <code>Finish</code> 时，如果没有调用 <code>finish</code> 则调用 <code>finish</code> 结束请求，并立即返回，结束处理流程。这样一来后续与异常处理相关的方法就不会被调用，也就不会影响到已经 <code>flush</code> 的内容。</p>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2016/01/30/tornado.web_handle_exception/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/29/tornado.web_response/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2016/01/29/tornado.web_response/" class="post-title-link" itemprop="url">tornado.web 消息响应实现</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2016-01-29 22:25:01" itemprop="dateCreated datePublished" datetime="2016-01-29T22:25:01+08:00">2016-01-29</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tornado/" itemprop="url" rel="index"><span itemprop="name">tornado</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>这部分笔记主要是简单分析 Tornado 中 Http 响应相关的代码，但没有涉及到安全相关的 cookie 实现以及 HTML 模板引擎。</p>
<h3 id="HTTPConnection"><a href="#HTTPConnection" class="headerlink" title="HTTPConnection"></a>HTTPConnection</h3><p><code>tornado.httputil</code> 模块定义了 Tornado 的响应接口 <code>HTTPConnection</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTTPConnection</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Applications use this interface to write their responses.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. versionadded:: 4.0</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_headers</span><span class="params">(self, start_line, headers, chunk=None, callback=None)</span>:</span></span><br><span class="line">        <span class="string">"""Write an HTTP header block.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :arg start_line: a `.RequestStartLine` or `.ResponseStartLine`.</span></span><br><span class="line"><span class="string">        :arg headers: a `.HTTPHeaders` instance.</span></span><br><span class="line"><span class="string">        :arg chunk: the first (optional) chunk of data.  This is an optimization</span></span><br><span class="line"><span class="string">            so that small responses can be written in the same call as their</span></span><br><span class="line"><span class="string">            headers.</span></span><br><span class="line"><span class="string">        :arg callback: a callback to be run when the write is complete.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns a `.Future` if no callback is given.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, chunk, callback=None)</span>:</span></span><br><span class="line">        <span class="string">"""Writes a chunk of body data.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        The callback will be run when the write is complete.  If no callback</span></span><br><span class="line"><span class="string">        is given, returns a Future.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finish</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""Indicates that the last body data has been written.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br></pre></td></tr></table></figure>
<p>之前已经分析过的 <code>tornado.http1connection.HTTP1Connection</code> 是该接口的实现（另一个实现是 <code>tornado.wsgi._WSGIConnection</code>）。上述定义的三个接口方法注释很完整，简单来说：</p>
<ol>
<li><p><code>write_headers</code> 方法用于写 Http 消息头，一次响应应该只调用一次。其中可选参数 <code>chunk</code>，是消息体数据，在响应数据较少的情况下灰常有用，很多时候我们都是调用一次该方法完成写消息头和消息体，而不会去单独调用 <code>write</code> 方法单独写消息体。</p>
</li>
<li><p><code>write</code> 方法用于写消息体。</p>
</li>
<li><p><code>finish</code> 方法用于告诉接口此次请求响应结束。</p>
</li>
</ol>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2016/01/29/tornado.web_response/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/24/tornado.httputil.parse_body_arguments/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2016/01/24/tornado.httputil.parse_body_arguments/" class="post-title-link" itemprop="url">tornado.httputil 对 Http request message-body 的解析</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2016-01-24 21:25:01" itemprop="dateCreated datePublished" datetime="2016-01-24T21:25:01+08:00">2016-01-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tornado/" itemprop="url" rel="index"><span itemprop="name">tornado</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="HTTPServerRequest-解析-message-body"><a href="#HTTPServerRequest-解析-message-body" class="headerlink" title="HTTPServerRequest 解析 message-body"></a>HTTPServerRequest 解析 message-body</h3><p>Tornado 对每次请求都会创建一个 <code>tornado.httputil.HTTPServerRequest</code> 实例。由之前的分析我们知道 Http Request 的 “Request-Line” 和头域解析工作已经在 <code>tornado.http1connection.Http1Connection</code> 中完成，所以在 <code>tornado.httputil.HTTPServerRequest</code> 中的主要工作就是对请求参数的解析，而其中对 message-body 的解析相比较 query 要复杂一些。</p>
<p>下面是 <code>HTTPServerRequest</code> 解析 message-body 的方法代码，其中解析结果存放在 <code>body_arguments</code> 和 <code>files</code> 字段中（注：字段 <code>arguments</code> 存放所有请求参数，包括 query 参数和 body 参数，对 query 的解析已经在 <code>HTTPServerRequest</code> 的构造函数中完成）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_parse_body</span><span class="params">(self)</span>:</span></span><br><span class="line">    parse_body_arguments(</span><br><span class="line">        self.headers.get(<span class="string">"Content-Type"</span>, <span class="string">""</span>), self.body,</span><br><span class="line">        self.body_arguments, self.files,</span><br><span class="line">        self.headers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> self.body_arguments.items():</span><br><span class="line">        self.arguments.setdefault(k, []).extend(v)</span><br></pre></td></tr></table></figure>
<p>由代码可知，<code>_parse_body</code> 方法对 body 解析是委托模块函数 <code>parse_body_arguments</code> 完成的。</p>
<h3 id="parse-body-arguments-函数"><a href="#parse-body-arguments-函数" class="headerlink" title="parse_body_arguments 函数"></a>parse_body_arguments 函数</h3><p>Http 协议是以ASCII码传输，建立在 TCP/IP 协议之上的应用层协议。协议把 Http 请求分成了三部分：<a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5" target="_blank" rel="noopener">请求行，请求头，消息体</a>。协议没有规定消息体中数据的编码方式。在浏览器 Form 表单 POST 提交时，如没有指定 <code>enctype</code> 属性的值，默认使用 <code>application/x-www-form-urlencoded</code> 方式编码提交，该编码方式不能用于文件上传。通常使用表单上传文件时使用 <code>multipart/form-data</code> 方式编码提交，这是浏览器原生支持的，就目前而言原生 Form 表单也只支持这<a href="https://www.w3.org/TR/html401/interact/forms.html#h-17.13.4" target="_blank" rel="noopener">两种方式</a>。另外还有 <code>application/json</code> 、 <code>text/xml</code>、<code>text/plain</code>、 <code>text/html</code> 等等编码方式，不过这些方式大多都用在 Response 上。实际上只要服务器支持，任何一种编码都可以在请求中使用，我觉得通过 <code>application/json</code> 编码请求数据在 RESTful 接口中非常有用。</p>
<p><code>tornado.httputil</code> 模块中的 <code>parse_body_arguments</code> 函数默认支持解析 <code>application/x-www-form-urlencoded</code> 和 <code>multipart/form-data</code> 编码的 body 数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_body_arguments</span><span class="params">(content_type, body, arguments, files, headers=None)</span>:</span></span><br><span class="line">    <span class="string">"""Parses a form request body.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Supports ``application/x-www-form-urlencoded`` and</span></span><br><span class="line"><span class="string">    ``multipart/form-data``.  The ``content_type`` parameter should be</span></span><br><span class="line"><span class="string">    a string and ``body`` should be a byte string.  The ``arguments``</span></span><br><span class="line"><span class="string">    and ``files`` parameters are dictionaries that will be updated</span></span><br><span class="line"><span class="string">    with the parsed contents.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 只支持解码后（或无编码）的 body 数据。实际上在 Tornado 中有专门的</span></span><br><span class="line">    <span class="comment"># `_GzipMessageDelegate` 类支持 `gzip` 解码，body 数据都通过其解码后再调用</span></span><br><span class="line">    <span class="comment"># `parse_body_arguments` 函数。参见 `Http1Connection.read_response` 实现。</span></span><br><span class="line">    <span class="comment"># `_GzipMessageDelegate` 处理请求后会删除其中的 'Content-Encoding' 头域，用</span></span><br><span class="line">    <span class="comment"># 'X-Consumed-Content-Encoding' 头域代替。</span></span><br><span class="line">    <span class="keyword">if</span> headers <span class="keyword">and</span> <span class="string">'Content-Encoding'</span> <span class="keyword">in</span> headers:</span><br><span class="line">        gen_log.warning(<span class="string">"Unsupported Content-Encoding: %s"</span>,</span><br><span class="line">                        headers[<span class="string">'Content-Encoding'</span>])</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> content_type.startswith(<span class="string">"application/x-www-form-urlencoded"</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            uri_arguments = parse_qs_bytes(native_str(body), keep_blank_values=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            gen_log.warning(<span class="string">'Invalid x-www-form-urlencoded body: %s'</span>, e)</span><br><span class="line">            uri_arguments = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> name, values <span class="keyword">in</span> uri_arguments.items():</span><br><span class="line">            <span class="keyword">if</span> values:</span><br><span class="line">                arguments.setdefault(name, []).extend(values)</span><br><span class="line">    <span class="keyword">elif</span> content_type.startswith(<span class="string">"multipart/form-data"</span>):</span><br><span class="line">        fields = content_type.split(<span class="string">";"</span>)</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> fields:</span><br><span class="line">            k, sep, v = field.strip().partition(<span class="string">"="</span>)</span><br><span class="line">            <span class="keyword">if</span> k == <span class="string">"boundary"</span> <span class="keyword">and</span> v:</span><br><span class="line">                parse_multipart_form_data(utf8(v), body, arguments, files)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gen_log.warning(<span class="string">"Invalid multipart/form-data"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="application-x-www-form-urlencoded"><a href="#application-x-www-form-urlencoded" class="headerlink" title="application/x-www-form-urlencoded"></a>application/x-www-form-urlencoded</h4><p>这是浏览器原生表单 <code>POST</code> 默认的编码方式，<code>GET</code> 默认的请求数据编码方式也是它，差别就在于 <code>GET</code> 时编码后的数据是放在 URL 中一起发送给服务器的，并且 URL 有一个 2048 字符长度的限制；<code>POST</code> 时编码后的数据是放在 Message-Body 中发送给服务器的，协议上并没有限制长度。</p>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2016/01/24/tornado.httputil.parse_body_arguments/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/19/tornado.web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2016/01/19/tornado.web/" class="post-title-link" itemprop="url">tornado.web 模块解析</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2016-01-19 17:25:01" itemprop="dateCreated datePublished" datetime="2016-01-19T17:25:01+08:00">2016-01-19</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tornado/" itemprop="url" rel="index"><span itemprop="name">tornado</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在前面 Tornado 的分析文章中已经详细介绍了 HttpServer 接收处理客户端 Http 连接请求，并将请求委托给请求回调（即 HttpServer.request_callback 字段，由 HttpServer 的构造参数来完成初始化）处理的流程。基于 HttpServer 的支持，tornado.web 模块为我们提供了一个简单的 Web 框架，该框架支持路由请求到对应的（自定义/默认）请求处理器（RequestHandler）并自带一个简易的 HTML 模板引擎。在分析 tornado.web 模块的设计之前，先通过一张图来回顾一下 HttpServer 的处理流程，看看 web.tornado 提供的框架是如何获得支持的。</p>
<img src="/2016/01/19/tornado.web/tornado.httpserver.jpg">
<p>由上图可知：</p>
<ol>
<li><p><code>httpsever.HttpServer</code> 继承自 <code>tcpserver.TCPServer</code> 并覆写了 <code>handle_stream(stream, address)</code> 方法。</p>
</li>
<li><p><code>httpsever.HttpServer.handle_stream(stream, address)</code> 方法中将请求相关的 IOStream、地址和协议描述（http/https）保证成 <code>httpsever._HTTPRequestContext</code> 实例以构建 <code>http1connection.HTTP1ServerConnection</code> 实例，并调用 <code>Http1ServerConnection.start_serving</code> 方法启动请求处理。</p>
</li>
<li><p><code>http1connection.HTTP1ServerConnection</code> 是一个支持 Http/1.x 的服务端抽象连接类型，也就是说能支持 Http/1.1 的长连接。在该连接实例服务周期中（实现在其 <code>_server_request_loop</code> 方法的 while 循环），其内部对于每一次 Http 请求会生成一个 <code>http1connection.HTTP1Connection</code> 实例。</p>
<ul>
<li><p><code>http1connection.Http1ServerConnection.start_serving(delegate:httputil.HTTPServerConnectionDelegate)</code> 方法要求接收一个 <code>httputil.HTTPServerConnectionDelegate</code> 实例，该实例的 <code>start_request(server_conn, request_conn:HTTP1Connection)</code> 方法返回一个 <code>httputil.HTTPMessageDelegate</code> 实例，该实例将与 <code>http1connection.HTTP1Connection</code> 实例配合处理 Http 请求的各个阶段。</p>
</li>
<li><p><code>http1connection.HTTP1Connection</code> 是 <code>httputil.HTTPConnection</code> 的 Http/1.x 子类实现，是每次 Http 连接请求的抽象，提供了读取请求和数据和发送响应数据的接口。<code>http1connection.HTTP1ServerConnection</code> 抽象了一个服务端的物理连接，<code>http1connection.HTTP1Connection</code> 则抽象了每次 Http 请求的连接，这样一来前者就可以基于同一个物理连接处理多个 Http 请求，也就是支持了 Http 协议要求的长连接。</p>
</li>
</ul>
</li>
<li><p><code>httpsever.HttpServer</code> 同时继承自 <code>httputil.HTTPServerConnectionDelegate</code>，所以它能作为 <code>http1connection.HTTP1ServerConnection.start_serving()</code> 方法的参数为其提供实际的请求处理。对请求的处理工作 <code>httpsever.HttpServer</code> 实际上是委托给其内部的 <code>request_callback</code> 字段来进行，该字段在 <code>httpsever.HttpServer</code> 构造时初始化。在 Tornado v4.0 之前的版本中，<code>request_callback</code> 是一个以 <code>httputil.HTTPServerRequest</code> 作为参数的回调对象，v4.0 之后引入 <code>httputil.HTTPMessageDelegate</code> 类型，随之 <code>request_callback</code> 改为支持 <code>httputil.HTTPMessageDelegate</code> 实例。为了向后兼容，<code>httpsever.HttpServer.start_request</code> 方法返回一个 <code>httpserver._ServerRequestAdapter</code> 类型实例。<code>httpserver._ServerRequestAdapter</code> 是一个对象适配器，它负责将之前的回调对象（适配者）适配到 <code>httputil.HTTPMessageDelegate</code> 类型。</p>
</li>
<li><p><code>web.Application</code> 继承自 <code>httputil.HTTPServerConnectionDelegate</code>，可作为请求连接处理回调对象传递给 <code>httpsever.HttpServer</code>， 作为其 <code>request_callback</code> 字段负责处理请求。</p>
</li>
</ol>
<p>到这里，<code>httpsever.HttpServer</code> 的整个处理过程基本回顾了一遍，后面处理将转到 <code>web.Application</code> ，开始进入 Tornado Web Framework 的处理流程。</p>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2016/01/19/tornado.web/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
        <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block home">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/14/Linux Daemon Processes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="格拉德.尼古拉斯.D.扯淡">
      <meta itemprop="description" content="疏影横斜水清浅，暗香浮动月黄昏。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="书影">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2016/01/14/Linux Daemon Processes/" class="post-title-link" itemprop="url">Linux 守护进程</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2016-01-14 15:00:00" itemprop="dateCreated datePublished" datetime="2016-01-14T15:00:00+08:00">2016-01-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-10-22 23:53:03" itemprop="dateModified" datetime="2019-10-22T23:53:03+08:00">2019-10-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/服务端基础/" itemprop="url" rel="index"><span itemprop="name">服务端基础</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="守护进程介绍"><a href="#守护进程介绍" class="headerlink" title="守护进程介绍"></a>守护进程介绍</h4><p><strong><em>本笔记内容主要参考自：《Advanced Programming in The Unix Environment 3rd edition》 第 13 章第 3 小节。</em></strong></p>
<p>守护进程是一类长时间运行的进程，一般随操作系统启动运行直到系统关闭而停止（也可以由 crond 启动，或者由用户终端 Shell 启动）。因为没有关联的控制终端，所以我们称其在后台运行，这也是守护进程最重要的特性。另一个重要的特性是守护进程必须与其运行前的环境隔离开。参考 《Advanced Programming in The Unix Environment》 第 13 章内容，编程实现守护进程有一些通用的设计规范。</p>
<h4 id="守护进程编码设计规范"><a href="#守护进程编码设计规范" class="headerlink" title="守护进程编码设计规范"></a>守护进程编码设计规范</h4><p>这里将介绍一些编码规范，这些规范将阻止守护进程与其运行前环境产生一些不必要的交互。</p>
<ol>
<li><p>Call umask to set the file mode creation mask to a known value, usually 0. The inherited file mode creation mask could be set to deny certain permissions. If the daemon process creates files, it may want to set specific permissions. For example, if it creates files with group-read and group-write enabled, a file mode creation mask that turns off either of these permissions would undo its efforts. On the other hand, if the daemon calls library functions that result in files being created, then it might make sense to set the file mode create mask to a more restrictive value (such as 007), since the library functions might not allow the caller to specify the permissions through an explicit argument.</p>
<p> 调用 umask 将文件创建掩码设置为一个值，通常是 0 。因为守护进程从父进程继承而来的 “文件创建掩码” 可能会屏蔽某些特定的文件操作权限。如果守护进程想要创建文件，那么便需要设置特定的文件操作权限。例如，守护进程想要创建允许用户组读和写权限的文件，继承而来的 “文件创建掩码” 屏蔽了这个权限，则创建操作不会成功。另一方面，如果后台进程调用的库函数会创建文件，但是库函数又不允许调用者通过一个明确的参数来指定文件的权限，为了安全起见将 “文件创建掩码” 设置为一个更严格的值（比如 007 ）是非常有意义和必要的。(<strong>注：默认情况下的 umask 值是 022 (可以用 umask 命令查看），此时你建立的文件默认权限是 644 (6-0,6-2,6-2)，建立的目录的默认权限是 755 (7-0,7-2,7-2)。使用 umask(0) 修改 “文件创建掩码” ，保证进程拥有文件的读写权限，这个操作很危险将导致新建的文件权限为 0666/world-writable 。这个操作通常用于文件创建者和修改者不是同一个用户的场景，比如：你需要创建一个文件，该文件后续会被 Web Server 修改，而 Web Server 使用的是另外一个用户运行。这种情况下为 Web Server 写文件的目录 Set Group ID（） 是个不错的选择。</strong>)</p>
</li>
<li><p>Call fork and have the parent exit. This does several things. First, if the daemon was started as a simple shell command, having the parent terminate makes the shell think that the command is done. Second, the child inherits the process group ID of the parent but gets a new process ID, so we’re guaranteed that the child is not a process group leader. This is a prerequisite for the call to setsid that is done next.</p>
<p> 调用 fork 创建子进程并使父进程退出，将守护进程放入后台运行。这个操作主要有两个目的。首先，如果守护进程是通过一个简单的 Shell 命令创建的，那么父进程结束时便会让 Shell 一并将守护进程也结束（<strong>注：在终端中 ctrl+c/delete 会向前台进程组所有进程发送中断信号，若父进程退出那么子进程便会被 init 进程接管进入后台运行。</strong>）；其次，子进程继承得到父进程的 “进程组ID” 同时也获得了一个新的进程号，这样便能保证子进程不是 “进程组组长” ，这是下一步 setsid 操作的前提（<strong>注：只有当前进程不是进程组组长时，才能调用 setsid 创建新会话。</strong>）。</p>
</li>
<li><p>Call setsid to create a new session. The three steps listed in Section 9.5 occur.The process (a) becomes the leader of a new session, (b) becomes the leader of a new process group, and (c) is disassociated from its controlling terminal.</p>
<p> 调用 setsid 创建一个新会话，这个调用实际会执行 3 个操作：(a) 使当前进程称为新会话的 “会话首进程”；(b) 使当前进程称为新 “进程组组长”；(c) 使当前进程脱离控制终端。（<strong>注：第 2 个操作使当前进程进入后台运行，这个操作接着使进程脱离原来的进程组、控制终端和会话。</strong>）</p>
<p> 在基于 System V 的系统中，有人建议再一次调用 fork 并使父进程退出，而新产生的进程将会成为真正的守护进程。这一步骤将保证守护进程不是一个 “会话首进程” ，进而阻止它重新申请获取一个控制终端。另外一种阻止守护进程重新申请获取控制终端的方法是任意时刻打开一个终端设备的时候明确指定 O_NOCTTY 标识（<strong>注：调用 open() 函数打开文件时，若文件是一个终端，指定 O_NOCTTY 标识后便不会让此终端成为该进程的控制终端。 </strong>） 。</p>
</li>
<li><p>Change the current working directory to the root directory. The current working directory inherited from the parent could be on a mounted file system. Since daemons normally exist until the system is rebooted, if the daemon stays on a mounted file system, that file system cannot be unmounted.</p>
<p> Alternatively, some daemons might change the current working directory to a specific location where they will do all their work. For example, a line printer spooling daemon might change its working directory to its spool directory.</p>
<p> 将当前工作目录切换到系统目录下。这是因为继承自父进程的当前工作目录可能是一个挂载的文件系统，而守护进程通常会一直运行到系统重启。如果守护进程工作在一个挂载的文件系统上，那么这个文件系统便不能被卸载。</p>
<p> 另外，有些守护进程会把当前工作目录切换到特定的路径下，并在这些路径下完成它们的工作。例如，行式打印机守护进程通常会将当前工作目录切换到 spool 目录。</p>
</li>
<li><p>Unneeded file descriptors should be closed. This prevents the daemon from holding open any descriptors that it may have inherited from its parent (which could be a shell or some other process). We can use our open_max function (Figure 2.17) or the getrlimit function (Section 7.11) to determine the highest descriptor and close all descriptors up to that value.</p>
<p> 关闭不必要的文件描述符。这将阻止守护进程保持任何从父进程（Shell 或者其他进程）进程而来的文件描述符。我们可以使用 open_max 或 getrlimit 函数来查找当前优先级最高的文件描述符并关闭此描述符之下的所有其他描述符。（<strong>注：保持打开的文件描述符将会占用系统资源并使某系文件不能被卸载。</strong>）</p>
</li>
<li><p>Some daemons open file descriptors 0, 1, and 2 to /dev/null so that any library routines that try to read from standard input or write to standard output or standard error will have no effect. Since the daemon is not associated with a terminal device, there is nowhere for output to be displayed, nor is there anywhere to receive input from an interactive user. Even if the daemon was started from an interactive session, the daemon runs in the background, and the login session can terminate without affecting the daemon. If other users log in on the same terminal device, we wouldn’t want output from the daemon showing up on the terminal, and the users wouldn’t expect their input to be read by the daemon.</p>
<p> 有些守护进程会将标准输入、标准输出、标准错误描述符重定向到 /dev/null，这样一来任何尝试从标准输入、标准输出或者标准错误读取守护进程信息的操作都会失败。因为守护进程不与任何终端设备关联，便没有地方显示输出或者接受用户输入。即使守护进程是由一个交互式会话创建，但由于其在后台运行，便不会受登录会话结束的影响；如果有其他用户通过当前终端登录，我们也不希望守护进程的输出出现在终端上，并且该用户的任何输入也不会被守护进程接收。</p>
</li>
<li><p>（<strong>注：引用自 <a href="http://www.cnblogs.com/mickole/p/3188321.html" target="_blank" rel="noopener">《linux系统编程之进程（八）：守护进程详解及创建，daemon()使用》</a></strong>）处理 SIGCHLD 信号。这不是一个必须的操作，但对于某些进程，特别是服务器进程（守护进程）往往在请求到来时生成子进程处理请求。如果父进程不等待子进程结束，子进程将成为僵尸进程（zombie ）从而占用系统资源。如果父进程等待子进程结束，将增加父进程的负担，影响服务器进程的并发性能。在 Linux 下可以简单地将SIGCHLD 信号的操作设为 SIG_IGN： <code>signal(SIGCHLD,SIG_IGN)</code>。这样，内核在子进程结束时不会产生僵尸进程。这一点与 BSD4 不同，BSD4 下必须显式等待子进程结束才能释放僵尸进程。</p>
</li>
</ol>
          <!--noindex-->
          
            <div class="post-button">
              <a class="btn" href="/2016/01/14/Linux Daemon Processes/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">格拉德.尼古拉斯.D.扯淡</p>
  <div class="site-description" itemprop="description">疏影横斜水清浅，暗香浮动月黄昏。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">格拉德.尼古拉斯.D.扯淡</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/muse.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  





















  

  

  

</body>
</html>
